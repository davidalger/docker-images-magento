name: Docker Image CI
on:
  schedule:
  - cron: "0 6 * * 1"   # 6 AM UTC on Monday
  push:
    branches:
    - master
  pull_request:

jobs:
  build:
    name: Magento ${{ matrix.MAJOR_VERSION }} (${{ matrix.MAGENTO_EDITION }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        MAJOR_VERSION:
          - "2.2"
          - "2.3"
        MAGENTO_EDITION:
          - "community"
        include:
          - MAJOR_VERSION: "2.2"
            BUILD_VERSIONS: "2.2.x"
            PHP_VERSION: "7.2"
            MAGENTO_EDITION: "community"
            IMAGE_NAME: "docker.io/davidalger/magento"

          - MAJOR_VERSION: "2.3"
            BUILD_VERSIONS: "2.3.x"
            PHP_VERSION: "7.3"
            MAGENTO_EDITION: "community"
            IMAGE_NAME: "docker.io/davidalger/magento"

    steps:
    - uses: actions/checkout@v1
    - name: build
      run: |
        set -x
        if [ "{{ github.event }}" == "push" ]; then
          ./scripts/build.sh --push
        else
          ./scripts/build.sh
        fi
      env:
        COMPOSER_AUTH: ${{ secrets.COMPOSER_AUTH }}
        BUILD_VERSIONS: ${{ matrix.BUILD_VERSIONS }}
        PHP_VERSION: ${{ matrix.PHP_VERSION }}
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        DOCKER_REGISTRY: docker.io
        MAGENTO_EDITION: ${{ matrix.MAGENTO_EDITION }}
        IMAGE_NAME: ${{ matrix.IMAGE_NAME }}
